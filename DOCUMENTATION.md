# tour-creator

* [Установка](#установка)  
* [Понятия](#понятия)  
* [Интерфейс](#интерфейс)  
* [Сборка и экспорт](#сборка-и-экспорт)  
* [Структура плагина](#структура-плагина)  


## Установка

### Способ 1

Плагин может быть установлен как **unity module**, для этого надо добавить ссылку на него в файл `Packages/manifest.json` вашего проекта:
```json
{
  "dependencies": {
        ...
    "com.rexagon.tour-creator": "https://github.com/ITLabRTUMIREA/tour-creator.git"
        ...
  }
}
```

> Из-за особенностей Unity при первом открытии редактора после добавления данного плагина в консоли могут появиться различные ошибки. Для их исправления просто перезапустите редактор.


### Способ 2

Склонируйте этот репозиторий в папку `Packages`. В данном случае `manifest.json` править не надо, но и автоматического обновления при выходе новых версий плагина *не будет*.

Для тех, кто захочет что-нибудь менять в плагине, можно добавить его в `Packages` как **git submodule**.



## Понятия

> Данный плагин задумывался как всеобъемлющий инструмент для создания совершенно любых видов экскурсий со всякими интерактивностями и т.д.. Но так как мы находимся в **Unity**, который *уже* имеет большой набор инструментов и скриптинг, то данный плагин предоставит лишь специфичные инструменты, сильно упрощающие создание экскурсий, а также базовые классы для расширения его функционала для конкретных нужд конечных проектов.

**Экскурсия** (тур) состоит из нескольких состояний и связей между ними. В проекте **Unity** одна экскурсия - одна сцена. Причём на сцене обязательно должен быть объект зрителя.

**Объект зрителя** - объект, содержащий основную логику управления и отображения. Он содержит в себе главную камеру и сферу, на которой будет отображаться фон. В итоговой сборке данные состояний используются для спавна внутри него маркеров перехода и других объектов.

**Состояние** представляет какую-то локацию, на которой каким-либо образом будет преподнесён контент. В один момент времени зритель может находится только в одном состоянии либо переходить между двумя. На сцене в качестве состояний используются **prefab**'ы, содержащие нужные компоненты с данными. В редакторе они отображаются реальными сферами на сцене, но в итоговой сборке в угоду производительности они никак не рисуются, а лишь предоставляют информацию объекту зрителя.

**Связь** - переход между двумя состояниями. Связь однонаправленная, но по умолчанию для двух состояний создаются две связи противоположных направлений. У начала и конца связи есть физическое представление, выраженное в виде маркера.



## Интерфейс

> После установки сверху должен появиться пункт меню **Tour Creator**, если вдруг его там нет, то проверьте правильность установки или наличие ошибок в консоли.

Для создания новой экскурсии нажмите **Tour Creator > New Tour**. Это создаст почти пустую сцену с одним лишь объектом зрителя. Лучше использовать именно такой способ, а не перетаскивать его **prefab** вручную, т.к. впоследствии может появится специфичная логика настройки сцены.

Откройте основной инструмент для экскурсий с помощью **Tour Creator > State Editor** и закрепите его куда-нибудь в удобное место. **Create new state** создаст на сцене новое пустое состояние. 

> Всегда создавайте новые состояния только через **State Editor**! Никогда не копируйте уже созданные состояния, если на них уже есть какие-либо связи!

У состояния есть некоторые параметры. Выберите только что созданное состояние и они появятся в **State Editor**.  

**Title** - название. Оно будет отображаться на маркере и оно будет являтся названием объекта в иерархии сцены. У разных состояний могут быть одинаковые названия.

**Panorama** - группа полей, специфичная для каждого источника изображения. На данный момент плагин предоставляет три источника:
* **FileImageSource** - обычный файл картинки с панорамой. Для того чтобы её можно было использовать, надо импортировать файл в проект. При экспорте экскурсии файл тоже будет экспортирован.
* **FileVideoSource** - файл видео 360. Для проигрывания видео используется [Unity VideoPlayer](https://docs.unity3d.com/ScriptReference/Video.VideoPlayer.html), так что видео должно быть в правильном формате и с правильными кодеками.  При экспорте экскурсии файл тоже будет экспортирован.

  Можно выставить режим проигрывания: 
  * **Restart On Enter** - при каждом переходе в это состояние, видео будет воспроизводится с начала.
  * **Loop In Background** - при первом переходе на это состояние видео запустится, а после этого будет без остановки проигрываться в фоне. Так как для отображения видео используется пул из **VideoPlayer**, таких состояний можно сделать несколько. Однако для экономии оперативной памяти и ресурсов процессора лучше делать их не очень много.
* **UrlImageSource** - панорама подгружается по url. Экспортируется она тоже в виде url.

> Для отображения используется [equirectangular projection (равнопромежуточная проекция)](https://ru.wikipedia.org/wiki/%D0%A0%D0%B0%D0%B2%D0%BD%D0%BE%D0%BF%D1%80%D0%BE%D0%BC%D0%B5%D0%B6%D1%83%D1%82%D0%BE%D1%87%D0%BD%D0%B0%D1%8F_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%86%D0%B8%D1%8F)

> При подборе панорам надо искать компромиссы между их разрешением и весом итоговой сборки. Минимально приемлемым разрешением является **2048 x 1024**, но всё зависит от целевой платформы

Создайте ещё одно состояние и выделите его вместе с предыдущим. В **State Editor** нажмите **Toggle connection** чтобы создать или удалить (если она уже была) связь между двумя состояниями. После этого выделите какое-нибудь одно состояние.

Для включения или выключения отображения связей используйте пункт меню **Tour Creator > Show Connections** или **Tour Creator > Show Labels** для названий.

Кнопка **Focus camera** переместит камеру внутрь панорамы. Так удобнее всего редактировать связи.

Перейдите в режим редактирования связей с помощью **Edit mode** и выберите из списка ниже связь (вокруг её маркера на сцене появится сетка), а дальше нажмите ЛКМ куда-нибудь на панораму.



## Сборка и экспорт

После того, как будут созданы и заполнены все нужные состояния со всеми нужными переходами, можно перейти к этапу сборки или экспорта.

Для начала надо указать исходное состояние у объекта зрителя. Перетащите из дерева сцены нужное состояние в поле **First State** компонента **Tour** объекта с названием `ViewSphere`. Также можно настроить скорость перехода.

Пройдитесь по всем использованным в проекте текстурам и выберите оптимальный метод сжатия для сокращения размера итоговой сборки. 

Из коробки в плагине доступен билд только под ПК. Для этого используйте пункт меню **Tour Creator > Build For Desktop**. После успешной сборки билд будет находится в корне проекта в папке `Build`.

Так же можно экспортировать проект в виде **json** файлика и набора использованных изображений и видео. Для этого есть пункт меню **Tour Creator > Export Tour**



## Структура плагина

Для использования плагина при создании более сложных экскурсий надо понимать его работу.

Плагин состоит из двух частей - та, которая работает только в редакторе (интерфейс и создание объектов на сцене) и та, которая работает в итоговой сборке.

### Редактор

* `Editor/TourEditor.cs` - хранит префабы по умолчанию, инициализирует работу **scene gui** и привязывает другие классы редактора к меню.
* `Editor/StateEditorWindow.cs` - окно инструмента **State Editor**. Его интерфейс и логика.
* `Editor/TextureSourceEditor.cs` - компонент интерфейса для встраивания параметров `TextureSource`.
* `Editor/StateGraphRenderer.cs` - рисует связи, метки, названия и т.д. в окне сцены.
* `Editor/ApplicationBuilder.cs` - содержит в себе логику для сборки проекта. Если нужно добавить сборку под новую платформу, то именно здесь дописывается нужная функция. *(да, это можно было сделать лучше, но сорян)*.
* `Editor/TourExporter.cs` - логика экспортирования экскурсии.

### Рантайм

* `Runtime/Tour.cs` - логика переходов, текущее состояние, настройки.
* `Runtime/State.cs` - объект состояния. В основном используется для физического отображения состояния в режиме редактора, а в рантайме используется как компонент-тэг.
* `Runtime/VideoPlayerPool.cs` - пул из **VideoPlayer** для одновременной обработки нескольких видео.
* `Runtime/VideoPreviewGenerator.cs` - одноразовый объект, который декодирует первый кадр видео в текстуру. Используется только в режиме редактора для `TextureSource`.
* `Runtime/TextureSource.cs` - базовый класс для источника изображения панорамы. Все наследники будут автоматически отображаться в соответствующем меню у состояния.  
  *Примеры реализации можно найти в `Runtime/TextureSources`.*
* `Runtime/Marker.cs` - класс для меток перехода. Из коробки может менять переменную анимации. Если нужна более сложная логика, то можно просто наследоваться.
* `Runtime/Pointer.cs` - базовый класс для логики управления камерой. В указателе реализуется логика вращения/перемещения и обработка нажатия на маркер.  
  *Примеры реализации можно найти в `Runtime/Pointers`.*
